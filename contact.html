<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expecto Patronum!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js removed as requested -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: #0d1117; /* Darkest, mysterious background */
            color: #e2e8f0;
        }
        /* Custom Dementor pulse for the fear bar */
        @keyframes fear-pulse {
            0%, 100% { box-shadow: 0 0 15px rgba(252, 165, 165, 0.5); }
            50% { box-shadow: 0 0 30px rgba(239, 68, 68, 1); }
        }
        .fear-pulsing {
            animation: fear-pulse 1s infinite alternate;
        }
        .magic-text {
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.7);
        }
        .icon-box {
            transition: all 0.2s;
            cursor: pointer;
        }
        .icon-box:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(147, 51, 234, 0.5);
        }
        .selected {
            border-color: #a78bfa; /* Violet */
            box-shadow: 0 0 15px #a78bfa;
            background-color: #6d28d9;
        }
        .btn-magic {
            background: linear-gradient(145deg, #7c3aed, #a78bfa);
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.4);
            transition: all 0.3s;
        }
        .btn-magic:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(124, 58, 237, 0.6);
        }

        /* --- New Patronus Glow and Wand Animation --- */

        /* Patronus Glow - Makes the Patronus look "real" and radiant */
        @keyframes patronus-glow {
            0%, 100% { filter: drop-shadow(0 0 10px #ffffff) drop-shadow(0 0 30px #bae6fd); }
            50% { filter: drop-shadow(0 0 15px #ffffff) drop-shadow(0 0 40px #60a5fa); }
        }
        .patronus-glowing {
            animation: patronus-glow 1s infinite alternate;
        }
        
        /* Wand animation when casting */
        @keyframes wand-flick {
            0% { transform: translate(0, -50%) scale(1); }
            50% { transform: translate(0, -50%) scale(1.3) rotate(10deg); color: #facc15; }
            100% { transform: translate(0, -50%) scale(1); }
        }
        .wand-casting {
            animation: wand-flick 0.3s ease-out;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="game-container" class="w-full max-w-3xl bg-slate-800 p-6 sm:p-10 rounded-2xl shadow-2xl border border-slate-700">
        
        <header class="text-center mb-8 relative">
            <h1 class="text-5xl sm:text-6xl font-extrabold text-indigo-400 mb-4 tracking-tight magic-text">Expecto Patronum!</h1>
            <!-- Music Toggle Button removed -->
            <p id="instruction-text" class="text-slate-300 text-lg font-medium">Choose your character and Patronus to begin the duel against the Dementors!</p>
        </header>

        <!-- Setup Screen -->
        <div id="setup-screen" class="space-y-8">
            
            <!-- Character Selection -->
            <div>
                <h2 class="text-2xl font-bold text-yellow-300 mb-4 border-b border-slate-700 pb-2">1. Select Your Champion</h2>
                <div id="character-selection" class="flex justify-around gap-4 flex-wrap">
                    <!-- Character options generated by JS -->
                </div>
            </div>

            <!-- Patronus Selection -->
            <div>
                <h2 class="text-2xl font-bold text-yellow-300 mb-4 border-b border-slate-700 pb-2">2. Choose Your Patronus</h2>
                <div id="patronus-selection" class="flex justify-around gap-4 flex-wrap">
                    <!-- Patronus options generated by JS -->
                </div>
            </div>

            <!-- Start Button -->
            <div class="text-center pt-4">
                <button id="start-button" class="btn-magic px-10 py-4 text-white font-bold rounded-full text-xl disabled:bg-gray-600 disabled:shadow-none">
                    START DUEL
                </button>
            </div>
        </div>

        <!-- Game Screen (Hidden initially) -->
        <div id="game-screen" class="hidden space-y-8">
            
            <!-- Result/Status Message -->
            <div id="result-box" class="min-h-[5rem] bg-slate-700 p-4 rounded-xl text-center flex items-center justify-center border border-slate-600">
                <p id="result-message" class="text-2xl font-bold text-yellow-300">
                    Dementor spotted! Quick! Cast the obstacle spell first!
                </p>
            </div>

            <!-- Duel Arena -->
            <div class="flex items-center justify-between relative bg-slate-900 p-6 rounded-xl border border-slate-700">
                
                <!-- Player Area -->
                <div id="player-area" class="relative flex flex-col items-center p-4 rounded-xl bg-red-800/20 border-2 border-red-500/50 w-1/3 transition-all duration-300">
                    <!-- Wand Element - positioned relative to player box -->
                    <span id="player-wand" class="absolute top-1/2 right-0 transform translate-x-1/2 -translate-y-1/2 text-3xl z-10 text-gray-400">ðŸª„</span>
                    <span id="player-icon" class="text-5xl sm:text-7xl"></span>
                    <p id="player-name" class="text-xl sm:text-2xl font-bold text-red-300 mt-2">Harry</p>
                </div>

                <!-- Dementor Influence Bar (Fear Bar) -->
                <div class="flex flex-col items-center mx-4 w-1/3">
                    <p class="text-sm font-medium text-red-400 mb-2">Dementor Influence (Fear)</p>
                    <div id="fear-bar-container" class="w-full h-6 bg-gray-700 rounded-full overflow-hidden border-2 border-red-500">
                        <div id="fear-bar" class="h-full bg-red-500 transition-all duration-100" style="width: 0%;"></div>
                    </div>
                    <p class="text-xs text-slate-500 mt-1">REACTION TIME</p>
                </div>

                <!-- Dementor Area -->
                <div class="flex flex-col items-center p-4 w-1/3">
                    <span class="text-7xl sm:text-9xl" role="img" aria-label="Dementor">ðŸ¥¶</span>
                    <p class="text-xl sm:text-2xl font-bold text-gray-400 mt-2">Dementor</p>
                </div>
            </div>
            
            <!-- Obstacle Prompt (New Feature) -->
            <div id="obstacle-prompt" class="text-center pt-2 hidden">
                <p class="text-xl text-orange-300 font-bold mb-2">OBSTACLE: Cast <span id="obstacle-spell" class="text-red-400"></span>!</p>
            </div>

            <!-- Patronus Icon (Hidden initially, appears on win) -->
            <div id="patronus-display" class="hidden text-center">
                <p class="text-3xl text-green-400 font-extrabold mb-4">EXPECTO PATRONUM!</p>
                <span id="patronus-icon" class="text-8xl text-sky-300 patronus-glowing"></span>
            </div>

            <!-- Action Button for Retry -->
            <div class="text-center pt-4">
                <button id="retry-button" class="btn-magic px-10 py-4 text-white font-bold rounded-full text-xl hidden">
                    PLAY AGAIN
                </button>
            </div>

        </div>

    </div>

    <script>
        // DOM Elements
        const setupScreenEl = document.getElementById('setup-screen');
        const gameScreenEl = document.getElementById('game-screen');
        const startButtonEl = document.getElementById('start-button');
        const retryButtonEl = document.getElementById('retry-button');
        const characterSelectionEl = document.getElementById('character-selection');
        const patronusSelectionEl = document.getElementById('patronus-selection');
        const instructionTextEl = document.getElementById('instruction-text');
        const resultMessageEl = document.getElementById('result-message');
        const fearBarEl = document.getElementById('fear-bar');
        const fearBarContainerEl = document.getElementById('fear-bar-container');
        const playerAreaEl = document.getElementById('player-area');
        const playerIconEl = document.getElementById('player-icon');
        const playerNameEl = document.getElementById('player-name');
        const patronusDisplayEl = document.getElementById('patronus-display');
        const patronusIconEl = document.getElementById('patronus-icon');
        const playerWandEl = document.getElementById('player-wand');
        const obstaclePromptEl = document.getElementById('obstacle-prompt');
        const obstacleSpellEl = document.getElementById('obstacle-spell');
        // const musicToggleEl = document.getElementById('music-toggle'); // Removed

        // Game Constants and State
        let gameState = 'setup'; // 'setup', 'playing', 'win', 'lose'
        let selectedCharacter = null;
        let selectedPatronus = null;
        let fearLevel = 0;
        // FEAR_RATE: 0.333 means 300 steps to 100%. At ~60 FPS, this is approx 5 seconds.
        const FEAR_RATE = 0.333; 
        const CAST_KEY = 'p'; // Key to cast Patronus
        let animationFrameId = null;

        // New Obstacle State
        let obstacleKey = '';
        let isObstacleCleared = false;
        
        const OBSTACLE_SPELLS = [
            { key: 'l', name: 'LUMOS', prompt: 'Need light! Press \'L\'!' },
            { key: 'r', name: 'REPARO', prompt: 'Repair something! Press \'R\'!' },
            { key: 'a', name: 'ACCIO', prompt: 'Summon something! Press \'A\'!' },
            { key: 'd', name: 'DIFFINDO', prompt: 'Sever something! Press \'D\'!' },
        ];

        const CHARACTERS = [
            { id: 'harry', name: 'Harry', icon: 'âš¡', colorClass: 'bg-red-800/20 border-red-500/50 text-red-300' },
            { id: 'hermione', name: 'Hermione', icon: 'ðŸ“š', colorClass: 'bg-indigo-800/20 border-indigo-500/50 text-indigo-300' },
            { id: 'ron', name: 'Ron', icon: 'ðŸ€', colorClass: 'bg-yellow-800/20 border-yellow-500/50 text-yellow-300' },
        ];

        const PATRONUSES = [
            { id: 'stag', name: 'Stag', emoji: 'ðŸ¦Œ' },
            { id: 'otter', name: 'Otter', emoji: 'ðŸ¦¦' },
            { id: 'dog', name: 'Dog', emoji: 'ðŸ•' },
            { id: 'phoenix', name: 'Phoenix', emoji: 'ðŸ¦' },
        ];
        
        // --- Music Setup removed ---
        
        // --- Setup and UI Generation ---

        function generateOptions(data, container, type) {
            data.forEach(item => {
                const div = document.createElement('div');
                div.className = 'icon-box p-4 rounded-xl border-2 border-slate-600 w-24 sm:w-32 text-center';
                div.innerHTML = `
                    <span class="text-4xl block mb-1">${item.icon || item.emoji}</span>
                    <p class="text-sm font-semibold">${item.name}</p>
                `;
                div.addEventListener('click', () => selectOption(item, type, div));
                container.appendChild(div);
            });
        }

        function selectOption(item, type, element) {
            const container = (type === 'character' ? characterSelectionEl : patronusSelectionEl);
            container.querySelectorAll('.icon-box').forEach(el => el.classList.remove('selected'));
            
            element.classList.add('selected');

            if (type === 'character') {
                selectedCharacter = item;
            } else {
                selectedPatronus = item;
            }

            // Start button logic
            startButtonEl.disabled = !(selectedCharacter && selectedPatronus);
        }

        // --- Game Logic ---

        function gameLoop(timestamp) {
            if (gameState !== 'playing') return;

            // Increase fear level based on time/rate
            fearLevel = Math.min(100, fearLevel + FEAR_RATE);

            // Update UI
            fearBarEl.style.width = `${fearLevel}%`;
            
            // Check for lose condition
            if (fearLevel >= 100) {
                cancelAnimationFrame(animationFrameId);
                endRound('lose');
                return;
            }

            // Add pulse effect when fear is high
            if (fearLevel > 70) {
                fearBarContainerEl.classList.add('fear-pulsing');
            } else {
                fearBarContainerEl.classList.remove('fear-pulsing');
            }

            animationFrameId = requestAnimationFrame(gameLoop);
        }

        function startGame() { // No longer async
            if (!selectedCharacter || !selectedPatronus) return;

            // Music start logic removed

            gameState = 'playing';
            fearLevel = 0;
            isObstacleCleared = false; // Reset obstacle state
            
            // 1. Setup Obstacle
            const randomObstacle = OBSTACLE_SPELLS[Math.floor(Math.random() * OBSTACLE_SPELLS.length)];
            obstacleKey = randomObstacle.key;
            obstacleSpellEl.textContent = randomObstacle.name;

            // 2. Setup UI
            setupScreenEl.classList.add('hidden');
            gameScreenEl.classList.remove('hidden');
            retryButtonEl.classList.add('hidden');
            patronusDisplayEl.classList.add('hidden');
            fearBarContainerEl.classList.remove('fear-pulsing');
            playerWandEl.classList.remove('wand-casting');

            // 3. Update Messages
            resultMessageEl.textContent = 'Dementor spotted! Quick! Cast the obstacle spell first!';
            obstaclePromptEl.classList.remove('hidden');
            instructionTextEl.textContent = randomObstacle.prompt; // Show the key hint

            // Apply character styling
            playerAreaEl.className = 'relative flex flex-col items-center p-4 rounded-xl border-2 w-1/3 transition-all duration-300 ' + selectedCharacter.colorClass;
            playerIconEl.textContent = selectedCharacter.icon;
            playerNameEl.textContent = selectedCharacter.name;
            resultMessageEl.classList.remove('text-red-400', 'text-green-400');
            resultMessageEl.classList.add('text-yellow-300');

            // Start listeners and loop
            document.addEventListener('keydown', handleKeyPress);
            animationFrameId = requestAnimationFrame(gameLoop);
        }

        function endRound(status) {
            if (gameState !== 'playing') return; 
            gameState = status;
            
            document.removeEventListener('keydown', handleKeyPress);
            cancelAnimationFrame(animationFrameId);
            fearBarContainerEl.classList.remove('fear-pulsing');
            obstaclePromptEl.classList.add('hidden');
            playerWandEl.classList.remove('wand-casting');

            if (status === 'win') {
                resultMessageEl.textContent = `SUCCESS! Your ${selectedPatronus.name} protects you!`;
                resultMessageEl.classList.remove('text-yellow-300', 'text-red-400');
                resultMessageEl.classList.add('text-green-400');
                
                patronusIconEl.textContent = selectedPatronus.emoji;
                patronusDisplayEl.classList.remove('hidden');
            } else { // lose
                resultMessageEl.textContent = 'FAILURE! The Dementor\'s influence took hold!';
                resultMessageEl.classList.remove('text-yellow-300', 'text-green-400');
                resultMessageEl.classList.add('text-red-400');
            }

            // Button text set to "PLAY AGAIN"
            retryButtonEl.textContent = 'PLAY AGAIN';
            retryButtonEl.classList.remove('hidden');
            const totalTime = Math.round(100 / FEAR_RATE * 100) / 100;
            instructionTextEl.textContent = `Game Over. The Dementor duel lasts only ${totalTime} seconds. You must react quickly!`;
        }
        
        /**
         * Resets the game to the initial state (startGame) after a win or loss.
         */
        function handleRetry() {
            // Simply call startGame to reset all duel variables and start the loop again
            startGame();
        }

        // --- Event Handlers ---

        function handleKeyPress(event) {
            if (gameState !== 'playing') return;

            const key = event.key.toLowerCase();
            
            // 1. Handle Obstacle Check
            if (!isObstacleCleared) {
                if (key === obstacleKey) {
                    isObstacleCleared = true;
                    // Animate wand
                    playerWandEl.classList.add('wand-casting');
                    setTimeout(() => playerWandEl.classList.remove('wand-casting'), 300);

                    resultMessageEl.textContent = `Obstacle Cleared! Now, cast EXPECTO PATRONUM ('P')!`;
                    resultMessageEl.classList.remove('text-yellow-300', 'text-red-400', 'text-orange-400');
                    resultMessageEl.classList.add('text-sky-400');
                    instructionTextEl.textContent = `Perfect! Now press 'P' to cast your Patronus!`;
                    
                    obstaclePromptEl.classList.add('hidden');
                } else if (key !== CAST_KEY) {
                    // Wrong key pressed for obstacle (but not Patronus)
                    resultMessageEl.textContent = `Wrong spell! Focus! You need to cast the correct spell first!`;
                    resultMessageEl.classList.remove('text-yellow-300', 'text-sky-400');
                    resultMessageEl.classList.add('text-orange-400');
                }
            }

            // 2. Handle Patronus Cast
            if (key === CAST_KEY) {
                event.preventDefault(); 
                if (isObstacleCleared) {
                    // Successful Patronus cast
                    playerWandEl.classList.add('wand-casting');
                    endRound('win');
                } else {
                    // Failed Patronus cast (obstacle not cleared)
                    resultMessageEl.textContent = `Focus! You must clear the initial obstacle first! Press '${obstacleKey.toUpperCase()}'!`;
                    resultMessageEl.classList.remove('text-yellow-300', 'text-sky-400');
                    resultMessageEl.classList.add('text-red-400');
                }
            }
        }
        
        // --- Initialization ---

        window.onload = function() {
            // Generate character options
            generateOptions(CHARACTERS, characterSelectionEl, 'character');
            
            // Generate Patronus options
            generateOptions(PATRONUSES, patronusSelectionEl, 'patronus');

            // Attach listeners
            startButtonEl.addEventListener('click', startGame);
            retryButtonEl.addEventListener('click', handleRetry);
            // Music toggle listener removed
        };
    </script>
</body>
</html>